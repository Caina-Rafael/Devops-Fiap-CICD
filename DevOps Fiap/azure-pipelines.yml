# Arquivo: azure-pipelines.yml

trigger:
  - main

variables:
  azureSubscription: 'sc-devops-fiap'
  webAppName: 'WA-devops-fiap'
  projectPath: '.'
  outputFolder: 'dist'

stages:

# ==========================================================
# STAGE 1: BUILD (Agente Self-Hosted)
# ==========================================================
- stage: Build
  displayName: '1. Build Simples'
  jobs:
  - job: BuildJob

    # üëá Seu agente self-hosted (PC_CAIN√É)
    pool:
      name: Default

    steps:

    - task: NodeTool@0
      displayName: '1. Configurar Node.js 20.x'
      inputs:
        versionSpec: '20.x'

    - task: Npm@1
      displayName: '2. Instalar Depend√™ncias'
      inputs:
        command: 'install'
        workingDir: '$(projectPath)'

    - task: Npm@1
      displayName: '3. Executar Build (Copiar index.html ‚Üí dist)'
      inputs:
        command: 'custom'
        customCommand: 'run build'
        workingDir: '$(projectPath)'

    - task: PublishBuildArtifacts@1
      displayName: '4. Publicar Artefato'
      inputs:
        pathToPublish: '$(projectPath)/$(outputFolder)'
        artifactName: 'drop'


# ==========================================================
# STAGE 2: DEPLOY (Hosted Ubuntu)
# ==========================================================
- stage: Deploy
  displayName: '2. Deploy para App Service'
  dependsOn: Build
  condition: succeeded()

  jobs:
  - deployment: DeployJob
    displayName: 'Deployment Job'
    environment: dev     # üëà Obrigat√≥rio

    pool:
      #vmImage: 'ubuntu-latest'
      name: Default
      
    strategy:
      runOnce:
        deploy:
          steps:

          - download: current
            artifact: drop

          - task: AzureWebApp@1
            displayName: 'Deploy para App Service'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appName: '$(webAppName)'
              package: '$(Pipeline.Workspace)/drop'

# ==========================================================
# STAGE 3: P√≥s-Deploy (Ping + Valida√ß√£o)
# ==========================================================
- stage: PostDeploy
  displayName: '3. P√≥s-Deploy'
  dependsOn: Deploy
  condition: succeeded()

  jobs:
  - job: ValidateSite
    displayName: 'Valida√ß√£o do App Service'
    pool:
      #vmImage: 'ubuntu-latest'
      name: Default

    steps:

      # üîç 1. Ping simples (DNS + rede)
      - script: |
          echo "Fazendo ping no site..."
          ping -c 4 "$(webAppName).azurewebsites.net"
        displayName: "Ping na URL do App Service"

      # üåê 2. Valida√ß√£o HTTP 200 usando curl
      - script: |
          echo "Validando resposta HTTP..."

          STATUS=$(curl -o /dev/null -s -w "%{http_code}\n" https://$(webAppName).azurewebsites.net)

          echo "Status retornado: $STATUS"

          if [ "$STATUS" -ne 200 ]; then
            echo "‚ùå A valida√ß√£o falhou! O site n√£o retornou HTTP 200."
            exit 1
          fi

          echo "‚úîÔ∏è Site respondendo corretamente com HTTP 200!"
        displayName: "Valida√ß√£o HTTP 200"

